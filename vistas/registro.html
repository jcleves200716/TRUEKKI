<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro</title>
  <link rel="stylesheet" href="../css/resgistro.css">
</head>
<body>
  <!-- Panel izquierdo -->
  <div class="left-panel"></div>

  <!-- Panel derecho -->
  <div class="right-panel">
      <div class="avatar">üë§</div>
      <div class="register-title">REGISTRO</div>

      <!-- FORMULARIO -->
      <form id="registroForm">
        <div class="input-group">
          <i>üë§</i>
          <input type="text" name="nombre" placeholder="Nombre completo *" required>
        </div>

        <div class="input-group">
          <i>üìß</i>
          <input type="email" name="email" placeholder="Email *" required>
        </div>

        <div class="input-group">
          <i>üîí</i>
          <input type="password" id="password" name="password" placeholder="Contrase√±a *" required>
          <span class="toggle-password" data-target="password">
            <img src="../img/ojo-cerrado.png" class="ojo" alt="Ver contrase√±a">
          </span>
        </div>

        <div class="input-group">
          <i>üîí</i>
          <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Confirmar contrase√±a *" required>
          <span class="toggle-password" data-target="confirmPassword">
            <img src="../img/ojo-cerrado.png" class="ojo" alt="Ver contrase√±a">
          </span>
        </div>
        <div class="error-message" id="passwordError">Las contrase√±as no coinciden</div>

        <div class="password-requirements">
          <h4>La contrase√±a debe contener:</h4>
          <div class="requirement" id="req-length">
            <span>‚Ä¢ M√≠nimo 8 caracteres</span>
          </div>
          <div class="requirement" id="req-uppercase">
            <span>‚Ä¢ Al menos una letra may√∫scula</span>
          </div>
          <div class="requirement" id="req-number">
            <span>‚Ä¢ Al menos un n√∫mero</span>
          </div>
          <div class="requirement" id="req-special">
            <span>‚Ä¢ Al menos un car√°cter especial (@$!%*?&)</span>
          </div>
        </div>

        <div class="button-group">
          <button type="submit" class="btn" id="submitBtn">REGISTRARSE</button>
          <button type="button" class="btn1">
            <a href="login.html">¬øYa tienes cuenta?</a>
          </button>
        </div>
        
        <div class="spinner" id="spinner"></div>
        <div class="error-message" id="formError"></div>
        <div class="success-message" id="successMessage">¬°Registro exitoso! Redirigiendo al login...</div>
      </form>
    
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Funci√≥n para mostrar/ocultar contrase√±a
        document.querySelectorAll(".toggle-password").forEach(toggle => {
            toggle.addEventListener("click", function () {
                const inputId = this.getAttribute("data-target");
                const input = document.getElementById(inputId);
                const img = this.querySelector("img");

                if (input.type === "password") {
                    input.type = "text";
                    img.src = "../img/ojo-abierto.png";
                } else {
                    input.type = "password";
                    img.src = "../img/ojo-cerrado.png";
                }
            });
        });

        // Elementos DOM
        const password = document.getElementById('password');
        const confirmPassword = document.getElementById('confirmPassword');
        const passwordError = document.getElementById('passwordError');
        const formError = document.getElementById('formError');
        const successMessage = document.getElementById('successMessage');
        const spinner = document.getElementById('spinner');
        const submitBtn = document.getElementById('submitBtn');
        
        // Elementos de requisitos
        const reqLength = document.getElementById('req-length');
        const reqUppercase = document.getElementById('req-uppercase');
        const reqNumber = document.getElementById('req-number');
        const reqSpecial = document.getElementById('req-special');

        // Validar fortaleza de la contrase√±a - CORREGIDO
        function validatePasswordStrength(pwd) {
            const hasMinLength = pwd.length >= 8;
            const hasUppercase = /[A-Z]/.test(pwd);
            const hasNumber = /[0-9]/.test(pwd);
            const hasSpecial = /[@$!%*?&]/.test(pwd); // ‚úÖ CORREGIDO - quitado el punto (.)
            
            return {
                valid: hasMinLength && hasUppercase && hasNumber && hasSpecial,
                hasMinLength,
                hasUppercase,
                hasNumber,
                hasSpecial
            };
        }

        // Actualizar la visualizaci√≥n de requisitos
        function updateRequirementsUI(strength) {
            reqLength.className = strength.hasMinLength ? 'requirement valid' : 'requirement invalid';
            reqUppercase.className = strength.hasUppercase ? 'requirement valid' : 'requirement invalid';
            reqNumber.className = strength.hasNumber ? 'requirement valid' : 'requirement invalid';
            reqSpecial.className = strength.hasSpecial ? 'requirement valid' : 'requirement invalid';
        }

        // Validar que las contrase√±as coincidan - CORREGIDO
        function validatePassword() {
            const pwdValue = password.value;
            const confirmValue = confirmPassword.value;
            
            const strength = validatePasswordStrength(pwdValue);
            updateRequirementsUI(strength);
            
            // ‚úÖ CORREGIDO - Validaci√≥n m√°s flexible
            if (pwdValue !== confirmValue && confirmValue !== '') {
                passwordError.style.display = 'block';
                return false;
            } else {
                passwordError.style.display = 'none';
                // Permitir env√≠o incluso si no cumple todos los requisitos (el backend validar√°)
                return pwdValue === confirmValue;
            }
        }

        // Event listeners para validaci√≥n en tiempo real
        password.addEventListener('input', function() {
            const strength = validatePasswordStrength(this.value);
            updateRequirementsUI(strength);
            validatePassword();
        });

        confirmPassword.addEventListener('input', validatePassword);

        // ‚úÖ MANEJO DEL ENV√çO DEL FORMULARIO CORREGIDO
        document.getElementById('registroForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // ‚úÖ CORREGIDO - Validaci√≥n m√°s simple
            const pwdValue = password.value;
            const confirmValue = confirmPassword.value;
            
            if (pwdValue !== confirmValue) {
                formError.textContent = 'Las contrase√±as no coinciden';
                formError.style.display = 'block';
                return;
            }
            
            if (pwdValue.length < 8) {
                formError.textContent = 'La contrase√±a debe tener al menos 8 caracteres';
                formError.style.display = 'block';
                return;
            }
            
            formError.style.display = 'none';
            successMessage.style.display = 'none';
            
            spinner.style.display = 'block';
            submitBtn.disabled = true;
            
            // Recoger datos del formulario (solo campos obligatorios)
            const formData = {
                nombre: document.querySelector('input[name="nombre"]').value.trim(),
                email: document.querySelector('input[name="email"]').value.trim(),
                password: pwdValue,
                confirmPassword: confirmValue
            };
            
            // ‚úÖ Validaci√≥n b√°sica frontend
            if (!formData.nombre || !formData.email || !formData.password) {
                formError.textContent = 'Por favor, completa todos los campos obligatorios';
                formError.style.display = 'block';
                spinner.style.display = 'none';
                submitBtn.disabled = false;
                return;
            }
            
            try {
                console.log("Enviando datos al servidor...", formData);
                
                // Enviar datos al servidor
                const response = await fetch('http://localhost:5000/registro', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                console.log("Respuesta del servidor:", data);
                
                if (data.success) {
                    successMessage.textContent = data.message;
                    successMessage.style.display = 'block';
                    
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                } else {
                    formError.textContent = data.message;
                    formError.style.display = 'block';
                    submitBtn.disabled = false;
                }
            } catch (error) {
                console.error('Error:', error);
                formError.textContent = 'Error de conexi√≥n con el servidor';
                formError.style.display = 'block';
                submitBtn.disabled = false;
            } finally {
                spinner.style.display = 'none';
            }
        });
    });
  </script>
</body>
</html>