<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>TRUEKKI - Detalle de Producto</title>
  <link rel="stylesheet" href="../css/producto.css">
  <link rel="stylesheet" href="../estilos/barra.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
 <header>
    <div class="header-content">
      <h1>TRUEKKI</h1>
      <div class="search-bar">
        <input type="text" placeholder="Buscar productos..." id="search-input">
        <button onclick="searchProducts()"><i class="fas fa-search"></i></button>
      </div>
      <div class="icons">
        <span class="icon" onclick="showSection('favorites')"><i class="fas fa-heart"></i></span>
        <span class="icon" onclick="showSection('messages')"><i class="fas fa-comment"></i></span>
        <span class="icon menu-btn" onclick="openMenu()"><i class="fas fa-bars"></i></span>
      </div> 
    </div>
  </header>

  <!-- Men√∫ lateral -->
  <div class="sidebar" id="sidebar">
    <span class="close-btn" onclick="closeMenu()">‚úñ</span>
    <div class="user-info">
      <div class="user-avatar" id="sidebar-avatar">US</div>
      <div class="user-name" id="sidebar-name">Usuario</div>
    </div>
    <a href="publicar_producto.html"><i class="fas fa-plus-circle"></i> Publicar</a>
    <a href="#"><i class="fas fa-bell"></i> Notificaciones</a>
    <a href="chat.html"><i class="fas fa-comments"></i> Chats</a>
    <a href="historial.html"><i class="fas fa-history"></i> Historial</a>
    <a href="perfil.html"><i class="fas fa-user"></i> Perfil</a>
    <a href="#"><i class="fas fa-question-circle"></i> Ayuda</a>
    <a href="subastas.html"><i class="fas fa-gavel"></i> Subastas</a>
    <a href="favoritos.html"><i class="fas fa-heart"></i> Mis Favoritos</a>
    <button onclick="logout()" class="cerrar-sesion"><i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n</button>
  </div>

  <!-- Overlay -->
  <div class="overlay" id="overlay" onclick="closeMenu()"></div>

  <!-- Contenido principal -->
  <div class="container" id="product-container">
    <div class="loading-state">
      <i class="fas fa-spinner fa-spin"></i>
      <p>Cargando producto...</p>
    </div>
  </div>

  <!-- Contenedor para centrar los elementos inferiores -->
  <div class="bottom-container">
    <!-- Mensaje al vendedor -->
    <div class="message-box">
      <div class="message-header">
        <span>ENVIAR MENSAJE AL VENDEDOR</span>
        <input type="text" class="message-input" id="message-to-seller" placeholder="Hola, ¬øsigue estando disponible?" value="Hola, ¬øsigue estando disponible?">
      </div>
      <button class="send-btn" id="send-message-btn" onclick="sendMessageToSeller()">
        <i class="fas fa-paper-plane"></i> ENVIAR MENSAJE
      </button>
    </div>

    <!-- Perfil del vendedor -->
    <div class="perfil">
      <p><b id="seller-name">LUIS FERNANDO RAM√çREZ.</b></p>
      <p id="seller-description">
        APASIONADO DEL MUNDO GAMER Y DE LA TECNOLOG√çA DE ALTO RENDIMIENTO. 
        CON M√ÅS DE 8 A√ëOS DE EXPERIENCIA EN LA VENTA Y ENSAMBLE DE COMPUTADORES GAMER, 
        SE HA GANADO UN LUGAR DE CONFIANZA DENTRO DE LA COMUNIDAD TECNOL√ìGICA.
      </p>
      <button onclick="viewSellerProfile()">VISITAR PERFIL</button>
    </div>

    <p class="last-update">
      ULTIMA ACTUALIZACION <span id="last-update-date">22/08/25</span>
    </p>

    <!-- Estad√≠sticas -->
    <div class="contenedor">
      <!-- Calificaci√≥n -->
      <div class="bloque" style="width:180px;">
        <div id="estrellas">
          <span class="estrellas" data-valor="1">&#9733;</span>
          <span class="estrellas" data-valor="2">&#9733;</span>
          <span class="estrellas" data-valor="3">&#9733;</span>
          <span class="estrellas" data-valor="4">&#9733;</span>
          <span class="estrellas" data-valor="5">&#9733;</span>
        </div>
        <p>CALIFICACION</p>
      </div>

      <!-- Gr√°fica -->
      <div class="bloque" style="width:300px;">
        <canvas id="grafica"></canvas>
      </div>

      <!-- Intercambios -->
      <div class="bloque" style="width:200px;">
        <p>TOTAL INTERCAMBIOS</p>
        <p class="intercambios">35/100</p>
        <p>ETIQUETAS DE RECONOCIMIENTO</p>
        <p>üèÜ ‚öô üíª</p>
      </div>
    </div>

    <!-- Comentarios -->
    <div class="comentarios-container">
      <h2>Comentarios</h2> 
      <div id="comentarios-lista"></div>
      <div class="form-comentario">
        <textarea id="comentario-input" rows="2" placeholder="Escribe un comentario..."></textarea>
        <button onclick="agregarComentario()">Comentar</button>
      </div>
    </div>
  </div>

  <!-- Modal de confirmaci√≥n -->
  <div class="modal" id="messageModal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Mensaje Enviado</h3>
        <button class="close-modal" onclick="closeMessageModal()">√ó</button>
      </div>
      <div class="modal-body">
        <p>Tu mensaje ha sido enviado correctamente al vendedor.</p>
        <div class="modal-actions">
          <button class="btn btn-primary" onclick="goToChat()">
            <i class="fas fa-comments"></i> Ir al Chat
          </button>
          <button class="btn btn-outline" onclick="continueBrowsing()">
            <i class="fas fa-shopping-bag"></i> Seguir Explorando
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="../js/auth.js"></script>
  <script>
    // Variables globales
    let currentProduct = null;
    let currentSeller = null;
    let currentUser = null;
    let esFavorito = false;
    let favoritoId = null;
    let calificaciones = [];
    let chart;



    // Cargar datos al iniciar
    document.addEventListener('DOMContentLoaded', async function() {
      // Verificar autenticaci√≥n
      if (!checkAuth()) {
        return;
      }
      
      // Obtener usuario del localStorage
      currentUser = getCurrentUser();
      
      // Obtener ID del producto de la URL
      const urlParams = new URLSearchParams(window.location.search);
      const productId = urlParams.get('id');
      
      if (!productId) {
        showError('No se ha especificado un producto');
        return;
      }
      
      // Cargar informaci√≥n del producto
      await loadProductData(productId);

      if (currentProduct) {
        await verificarFavorito();
      }
      function updateUserInfo() {
      document.getElementById('sidebar-avatar').textContent = getInitials(currentUser.nombre);
      document.getElementById('sidebar-name').textContent = currentUser.nombre;
    }

    // Obtener iniciales del nombre
    function getInitials(name) {
      return name.split(' ').map(word => word[0]).join('').toUpperCase().substring(0, 2);
    }
    });

    // Men√∫ lateral
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("overlay");

    function openMenu() {
      sidebar.style.width = "280px";
      overlay.style.display = "block";
    }

    function closeMenu() {
      sidebar.style.width = "0";
      overlay.style.display = "none";
    }
    // ========== FUNCIONALIDAD DE MENSAJES AL VENDEDOR ==========

    // Enviar mensaje al vendedor
    async function sendMessageToSeller() {
      try {
        const messageInput = document.getElementById('message-to-seller');
        const message = messageInput.value.trim();
        const sendBtn = document.getElementById('send-message-btn');
        
        if (!message) {
          showNotification('Por favor escribe un mensaje', 'error');
          return;
        }

        if (!currentUser || !currentUser.id) {
          showNotification('Debes iniciar sesi√≥n para enviar mensajes', 'error');
          window.location.href = 'login.html';
          return;
        }

        // Deshabilitar bot√≥n mientras se env√≠a
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ENVIANDO...';

        console.log('üìç Iniciando conversaci√≥n con vendedor:', currentSeller.id);
        
        // 1. Crear o obtener conversaci√≥n
        const conversationResponse = await fetch('http://localhost:5000/chat/conversacion', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            id_usuario1: currentUser.id,
            id_usuario2: currentSeller.id
          })
        });

        if (!conversationResponse.ok) {
          throw new Error(`Error HTTP: ${conversationResponse.status}`);
        }

        const conversationResult = await conversationResponse.json();
        
        if (!conversationResult.success) {
          throw new Error(conversationResult.message);
        }

        const conversation = conversationResult.conversacion;
        console.log('‚úÖ Conversaci√≥n:', conversation);

        // 2. Enviar mensaje
        const messageResponse = await fetch('http://localhost:5000/chat/mensaje', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            id_conversacion: conversation.id_conversacion,
            id_remitente: currentUser.id,
            mensaje: message
          })
        });

        if (!messageResponse.ok) {
          throw new Error(`Error HTTP: ${messageResponse.status}`);
        }

        const messageResult = await messageResponse.json();
        
        if (!messageResult.success) {
          throw new Error(messageResult.message);
        }

        console.log('‚úÖ Mensaje enviado correctamente');
        
        // Mostrar modal de √©xito
        showMessageModal();
        
      } catch (error) {
        console.error('‚ùå Error enviando mensaje:', error);
        showNotification('Error al enviar mensaje: ' + error.message, 'error');
        
        // Rehabilitar bot√≥n
        const sendBtn = document.getElementById('send-message-btn');
        sendBtn.disabled = false;
        sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> ENVIAR MENSAJE';
      }
    }

    // Mostrar modal de mensaje enviado
    function showMessageModal() {
      const modal = document.getElementById('messageModal');
      modal.style.display = 'flex';
      
      // Rehabilitar bot√≥n
      const sendBtn = document.getElementById('send-message-btn');
      sendBtn.disabled = false;
      sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> ENVIAR MENSAJE';
    }

    // Cerrar modal
    function closeMessageModal() {
      const modal = document.getElementById('messageModal');
      modal.style.display = 'none';
    }

    // Ir al chat despu√©s de enviar mensaje
    function goToChat() {
      closeMessageModal();
      window.location.href = 'chat.html';
    }

    // Seguir explorando productos
    function continueBrowsing() {
      closeMessageModal();
      // Puedes redirigir a la p√°gina principal o dejar en la misma p√°gina
      // window.location.href = 'barra.html';
    }

    // Ver perfil del vendedor
    function viewSellerProfile() {
      // Por ahora redirige al perfil del usuario actual
      // En una implementaci√≥n completa, redirigir√≠a al perfil del vendedor
      window.location.href = 'perfil.html';
    }

    // ========== FUNCIONALIDAD EXISTENTE DEL PRODUCTO ==========

    // Cargar datos del producto desde la API
    async function loadProductData(productId) {
      try {
        console.log('Cargando producto ID:', productId);
        
        const response = await fetch(`http://localhost:5000/producto/${productId}`);
        
        if (!response.ok) {
          throw new Error(`Error HTTP: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('Respuesta del servidor:', result);
        
        if (result.success) {
          currentProduct = result.producto;
          currentSeller = result.vendedor;
          renderProduct(currentProduct, currentSeller);
          updateSellerInfo(currentSeller);
        } else {
          showError('Error: ' + result.message);
        }
      } catch (error) {
        console.error('Error cargando producto:', error);
        showError('Error de conexi√≥n. Verifica que el servidor est√© ejecut√°ndose.');
      }
    }

    // Actualizar informaci√≥n del vendedor en la UI
    function updateSellerInfo(seller) {
      document.getElementById('seller-name').textContent = seller.nombre + '.';
      // Aqu√≠ podr√≠as cargar m√°s informaci√≥n del vendedor si est√° disponible
    }

    // Renderizar producto
    function renderProduct(product, seller) {
      const container = document.getElementById('product-container');
      
      container.innerHTML = `
        <!-- Galer√≠a lateral -->
        <div class="gallery">
          ${product.foto ? 
            `<img src="http://localhost:5000/imagen-producto/${product.id_producto}" 
                 alt="${product.titulo}" 
                 onerror="handleImageError(this)">` : 
            '<div class="no-image">Imagen no disponible</div>'
          }
        </div>

        <!-- Imagen principal -->
        <div class="main-image">
          ${product.foto ? 
            `<img src="http://localhost:5000/imagen-producto/${product.id_producto}" 
                 alt="${product.titulo}"
                 onerror="handleImageError(this)">` : 
            '<div class="no-image">Imagen no disponible</div>'
          }
        </div>

        <!-- Detalles -->
        <div class="details">
          <h2>${product.titulo}</h2>
          <p>${product.descripcion}</p>

          <div class="price">
            <b>Precio:</b> ${product.precio ? `$${parseInt(product.precio).toLocaleString()}` : 'Negociable'}
          </div>
          
          <p><b>Ubicaci√≥n:</b> ${product.ciudad}, ${product.barrio}</p>
          
          <p><b>Vendedor:</b> ${seller.nombre}</p>

          <div class="tags">
            <span class="tag">${product.categoria}</span>
            <span class="tag">${product.estado}</span>
            <span class="tag">${product.contacto === 'whatsapp' ? 'WhatsApp' : 'Mensaje'}</span>
          </div>
          
          <div class="tags">
            <span class="tag2">venta</span>
            <span class="tag2">trueque</span>
            <span class="tag2">venta/trueque</span>
          </div>

          <div class="btns">
            <button onclick="addToWishlist(${product.id_producto})">
              <i class="fas fa-heart"></i> Lista deseos
            </button>
            <button onclick="shareProduct()">
              <i class="fas fa-share"></i> Compartir
            </button>
          </div>

          <!-- SECCI√ìN DE FAVORITOS -->
          <div class="favorite-section">
            <button id="btn-favorito" class="btn-favorito" onclick="toggleFavorito()">
              <i class="far fa-heart"></i> Agregar a Favoritos
            </button>
          </div>
        </div>
      `;

      // Verificar estado de favorito despu√©s de renderizar
      setTimeout(verificarFavorito, 100);
    }

    // ========== FUNCIONES AUXILIARES ==========

    // Manejar error de imagen
    function handleImageError(img) {
      img.style.display = 'none';
      img.parentElement.innerHTML = '<div class="no-image">Imagen no disponible</div>';
    }

    // Mostrar notificaci√≥n
    function showNotification(mensaje, tipo = 'success') {
      const notificacion = document.createElement('div');
      notificacion.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        background: ${tipo === 'success' ? '#28a745' : '#dc3545'};
        color: white;
        border-radius: 5px;
        z-index: 1000;
        font-family: Arial, sans-serif;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      `;
      notificacion.textContent = mensaje;
      
      document.body.appendChild(notificacion);
      
      setTimeout(() => {
        if (document.body.contains(notificacion)) {
          document.body.removeChild(notificacion);
        }
      }, 3000);
    }

    // ========== FUNCIONES EXISTENTES (mantener las que ya tienes) ==========

    // ... (mant√©n todas tus funciones existentes como verificarFavorito, toggleFavorito, 
    // agregarFavorito, eliminarFavorito, actualizarBotonFavorito, etc.)

    // Funci√≥n para verificar si el producto est√° en favoritos
    async function verificarFavorito() {
      try {
        const usuario = getCurrentUser();
        if (!usuario || !usuario.id) return;

        const response = await fetch(`http://localhost:5000/favoritos/verificar/${usuario.id}/${currentProduct.id_producto}`);
        const result = await response.json();
        
        if (result.success) {
          esFavorito = result.esFavorito;
          actualizarBotonFavorito();
        }
      } catch (error) {
        console.error('Error verificando favorito:', error);
      }
    }

    // Funci√≥n para alternar favorito
    async function toggleFavorito() {
      try {
        const usuario = getCurrentUser();
        if (!usuario || !usuario.id) {
          showNotification('Debes iniciar sesi√≥n para agregar favoritos', 'error');
          window.location.href = '../vistas/login.html';
          return;
        }

        if (esFavorito) {
          await eliminarFavorito();
        } else {
          await agregarFavorito();
        }
      } catch (error) {
        console.error('Error al manejar favorito:', error);
        showNotification('Error al procesar la acci√≥n', 'error');
      }
    }

    // Funci√≥n para agregar a favoritos
    async function agregarFavorito() {
      const usuario = getCurrentUser();
      
      const response = await fetch('http://localhost:5000/favoritos/agregar', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          id_usuario: usuario.id,
          id_producto: currentProduct.id_producto
        })
      });

      const result = await response.json();
      
      if (result.success) {
        esFavorito = true;
        favoritoId = result.id_favorito;
        actualizarBotonFavorito();
        showNotification('Producto agregado a favoritos');
      } else {
        showNotification(result.message, 'error');
      }
    }

    // Funci√≥n para eliminar de favoritos
    async function eliminarFavorito() {
      const usuario = getCurrentUser();
      
      const response = await fetch('http://localhost:5000/favoritos/eliminar', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          id_usuario: usuario.id,
          id_producto: currentProduct.id_producto
        })
      });

      const result = await response.json();
      
      if (result.success) {
        esFavorito = false;
        favoritoId = null;
        actualizarBotonFavorito();
        showNotification('Producto eliminado de favoritos');
      } else {
        showNotification(result.message, 'error');
      }
    }

    // Funci√≥n para actualizar la apariencia del bot√≥n
    function actualizarBotonFavorito() {
      const boton = document.getElementById('btn-favorito');
      if (!boton) return;

      if (esFavorito) {
        boton.innerHTML = '<i class="fas fa-heart"></i> Eliminar de Favoritos';
        boton.classList.add('favorito-activo');
      } else {
        boton.innerHTML = '<i class="far fa-heart"></i> Agregar a Favoritos';
        boton.classList.remove('favorito-activo');
      }
    }

    // ... (mant√©n el resto de tus funciones existentes como agregarComentario, 
    // actualizarEstrellas, crearGrafica, etc.)

  </script>

</body>
</html>