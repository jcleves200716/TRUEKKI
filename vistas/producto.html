<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>TRUEKKI - Detalle de Producto</title>
  <link rel="stylesheet" href="../css/producto.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <!-- Encabezado -->
  <header>
    <h1 onclick="window.location.href='barra.html'">TRUEKKI</h1>
    <input type="text" class="search-bar" placeholder="üîç Buscar productos...">
    <div class="header-icons">
      <span onclick="window.location.href='favoritos.html'">‚ô°</span>
      <span onclick="window.location.href='perfil.html'">üë§</span>
      <span onclick="openMenu()">‚ò∞</span>
    </div>
  </header>

  <!-- Contenido principal -->
  <div class="container" id="product-container">
    <div class="loading-state">
      <i class="fas fa-spinner fa-spin"></i>
      <p>Cargando producto...</p>
    </div>
  </div>

  <!-- Contenedor para centrar los elementos inferiores -->
  <div class="bottom-container">
    <!-- Mensaje al vendedor -->
    <div class="message-box">
      <div class="message-header">
        <span>ENVIAR MENSAJE AL VENDEDOR</span>
        <input type="text" class="message-input" value="Hola, ¬øsigue estando disponible?">
      </div>
      <button class="send-btn">ENVIAR MENSAJE</button>
    </div>

    <!-- Perfil del vendedor -->
    <div class="perfil">
      <p><b>LUIS FERNANDO RAM√çREZ.</b></p>
      <p>APASIONADO DEL MUNDO GAMER Y DE LA TECNOLOG√çA DE ALTO RENDIMIENTO. 
         CON M√ÅS DE 8 A√ëOS DE EXPERIENCIA EN LA VENTA Y ENSAMBLE DE COMPUTADORES GAMER, 
         SE HA GANADO UN LUGAR DE CONFIANZA DENTRO DE LA COMUNIDAD TECNOL√ìGICA.</p>
      <button>VISITAR PERFIL</button>
    </div>

    <p class="last-update">
      ULTIMA ACTUALIZACION <span>22/08/25</span>
    </p>

    <!-- Estad√≠sticas -->
    <div class="contenedor">
      <!-- Calificaci√≥n -->
      <div class="bloque" style="width:180px;">
        <div id="estrellas">
          <span class="estrellas" data-valor="1">&#9733;</span>
          <span class="estrellas" data-valor="2">&#9733;</span>
          <span class="estrellas" data-valor="3">&#9733;</span>
          <span class="estrellas" data-valor="4">&#9733;</span>
          <span class="estrellas" data-valor="5">&#9733;</span>
        </div>
        <p>CALIFICACION</p>
      </div>

      <!-- Gr√°fica -->
      <div class="bloque" style="width:300px;">
        <canvas id="grafica"></canvas>
      </div>

      <!-- Intercambios -->
      <div class="bloque" style="width:200px;">
        <p>TOTAL INTERCAMBIOS</p>
        <p class="intercambios">35/100</p>
        <p>ETIQUETAS DE RECONOCIMIENTO</p>
        <p>üèÜ ‚öô üíª</p>
      </div>
    </div>

    <!-- Comentarios -->
    <div class="comentarios-container">
      <h2>Comentarios</h2> 
      <div id="comentarios-lista"></div>
      <div class="form-comentario">
        <textarea id="comentario-input" rows="2" placeholder="Escribe un comentario..."></textarea>
        <button onclick="agregarComentario()">Comentar</button>
      </div>
    </div>
  </div>

  <!-- Resto del script se mantiene igual -->
  <script src="../js/auth.js"></script>
  <script>
    
    let currentProduct = null;
    let currentSeller = null;

    // Cargar datos al iniciar
    document.addEventListener('DOMContentLoaded', async function() {
      // Verificar autenticaci√≥n
      if (!checkAuth()) {
        return;
      }
      
      // Obtener ID del producto de la URL
      const urlParams = new URLSearchParams(window.location.search);
      const productId = urlParams.get('id');
      
      if (!productId) {
        showError('No se ha especificado un producto');
        return;
      }
      
      // Cargar informaci√≥n del producto
      await loadProductData(productId);
    });

    // Cargar datos del producto desde la API
    async function loadProductData(productId) {
      try {
        console.log('Cargando producto ID:', productId);
        
        const response = await fetch(`http://localhost:5000/producto/${productId}`);
        
        if (!response.ok) {
          throw new Error(`Error HTTP: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('Respuesta del servidor:', result);
        
        if (result.success) {
          currentProduct = result.producto;
          currentSeller = result.vendedor;
          renderProduct(currentProduct, currentSeller);
        } else {
          showError('Error: ' + result.message);
        }
      } catch (error) {
        console.error('Error cargando producto:', error);
        showError('Error de conexi√≥n. Verifica que el servidor est√© ejecut√°ndose.');
      }
    }

    // Renderizar producto
    function renderProduct(product, seller) {
      const container = document.getElementById('product-container');
      
      container.innerHTML = `
        <!-- Galer√≠a lateral -->
        <div class="gallery">
          ${product.foto ? 
            `<img src="http://localhost:5000/imagen-producto/${product.id_producto}" 
                 alt="${product.titulo}" 
                 onerror="handleImageError(this)">` : 
            '<div class="no-image">Imagen no disponible</div>'
          }
        </div>

        <!-- Imagen principal -->
        <div class="main-image">
          ${product.foto ? 
            `<img src="http://localhost:5000/imagen-producto/${product.id_producto}" 
                 alt="${product.titulo}"
                 onerror="handleImageError(this)">` : 
            '<div class="no-image">Imagen no disponible</div>'
          }
        </div>

        <!-- Detalles -->
        <div class="details">
          <h2>${product.titulo}</h2>
          <p>${product.descripcion}</p>

          <div class="price">
            <b>Precio:</b> ${product.precio ? `$${parseInt(product.precio).toLocaleString()}` : 'Negociable'}
          </div>
          
          <p><b>Ubicaci√≥n:</b> ${product.ciudad}, ${product.barrio}</p>
          
          <p><b>Vendedor:</b> ${seller.nombre}</p>

          <div class="tags">
            <span class="tag">${product.categoria}</span>
            <span class="tag">${product.estado}</span>
            <span class="tag">${product.contacto === 'whatsapp' ? 'WhatsApp' : 'Mensaje'}</span>
          </div>
          
          <div class="tags">
           <span class="tag2">venta</span>
           <span class="tag2">trueque</span>
           <span class="tag2">venta/trueque</span>
          </div>

          <div class="btns">
            <button onclick="addToWishlist(${product.id_producto})">
              <i class="fas fa-heart"></i> Lista deseos
            </button>
            <button onclick="shareProduct()">
              <i class="fas fa-share"></i> Compartir
            </button>
          </div>
        </div>

        
      `;
    }

    // Manejar error de imagen
    function handleImageError(img) {
      img.style.display = 'none';
      img.parentElement.innerHTML = '<div class="no-image">Imagen no disponible</div>';
    }

    
    // Agregar a lista de deseos
    function addToWishlist(productId) {
      alert('Producto agregado a lista de deseos');
      // Aqu√≠ integrar√≠as con tu sistema de favoritos
    }

    // Compartir producto
    function shareProduct() {
      if (navigator.share) {
        navigator.share({
          title: currentProduct.titulo,
          text: currentProduct.descripcion.substring(0, 100) + '...',
          url: window.location.href
        });
      } else {
        alert('Enlace copiado: ' + window.location.href);
      }
    }

    // Mostrar error
    function showError(message) {
      const container = document.getElementById('product-container');
      container.innerHTML = `
        <div class="error-state">
          <i class="fas fa-exclamation-triangle"></i>
          <h3>Error</h3>
          <p>${message}</p>
          <button class="btn-retry" onclick="window.location.reload()">Reintentar</button>
          <button class="btn-retry" onclick="window.location.href='barra.html'">Volver al inicio</button>
        </div>
      `;
    }

    // Men√∫ lateral
    function openMenu() {
      alert('Men√∫ de navegaci√≥n');
    }
       // Estrellas de calificaci√≥n
    const estrellas = document.querySelectorAll('.estrellas');
    let calificaciones = [];
    let chart;

    estrellas.forEach(estrella => {
      estrella.addEventListener('click', () => {
        let valor = estrella.getAttribute('data-valor');
        calificaciones.push(parseInt(valor));
        actualizarEstrellas(valor);
        actualizarGrafica();
      });
    });

    function actualizarEstrellas(valor) {
      estrellas.forEach(e => {
        e.classList.toggle('estrella-activa', e.getAttribute('data-valor') <= valor);
      });
    }

    // Gr√°fica con Chart.js
    function crearGrafica() {
      const ctx = document.getElementById('grafica').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: ["1‚òÖ", "2‚òÖ", "3‚òÖ", "4‚òÖ", "5‚òÖ"],
          datasets: [{
            label: "Cantidad de calificaciones",
            data: [0,0,0,0,0],
            borderColor: "blue",
            borderWidth: 2,
            fill: false
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          }
        }
      });
    }

    function actualizarGrafica() {
      let conteo = [0,0,0,0,0];
      calificaciones.forEach(c => conteo[c-1]++);
      chart.data.datasets[0].data = conteo;
      chart.update();
    }

    crearGrafica();

    function agregarComentario() {
    const input = document.getElementById("comentario-input");
    const texto = input.value.trim();

    if (texto === "") return;

    const lista = document.getElementById("comentarios-lista");

    function agregarComentario() {
  const input = document.getElementById("comentario-input");
  const texto = input.value.trim();

  if (texto === "") return;

  const lista = document.getElementById("comentarios-lista");

  // Crear contenedor del comentario
  const comentario = document.createElement("div");
  comentario.classList.add("comentario");

  // Imagen de perfil
  const img = document.createElement("img");
  img.src = "https://i.pinimg.com/736x/d2/50/af/d250af5bf078a388b23d9916b575dc48.jpg";

  // Contenedor texto
  const comentarioTexto = document.createElement("div");
  comentarioTexto.classList.add("comentario-texto");

  const nombre = document.createElement("h4");
  nombre.textContent = "Usuario";

  const contenido = document.createElement("p");
  contenido.textContent = texto;

  // Botones de acci√≥n
  const acciones = document.createElement("div");
  acciones.classList.add("comentario-acciones");

  const btnEditar = document.createElement("button");
  btnEditar.textContent = "Editar";
  btnEditar.classList.add("btn-editar");
  btnEditar.onclick = () => {
    const nuevoTexto = prompt("Edita tu comentario:", contenido.textContent);
    if (nuevoTexto !== null && nuevoTexto.trim() !== "") {
      contenido.textContent = nuevoTexto.trim();
    }
  };

  const btnEliminar = document.createElement("button");
  btnEliminar.textContent = "Eliminar";
  btnEliminar.classList.add("btn-eliminar");
  btnEliminar.onclick = () => {
    lista.removeChild(comentario);
  };

  acciones.appendChild(btnEditar);
  acciones.appendChild(btnEliminar);

  // Insertar todo en el contenedor
  comentarioTexto.appendChild(nombre);
  comentarioTexto.appendChild(contenido);
  comentarioTexto.appendChild(acciones);

  comentario.appendChild(img);
  comentario.appendChild(comentarioTexto);

  lista.appendChild(comentario);

  // Limpiar textarea
  input.value = "";
}
    // Crear contenedor del comentario
    const comentario = document.createElement("div");
    comentario.classList.add("comentario");

    // Imagen de perfil (fija por ahora)
    const img = document.createElement("img");
    img.src = "https://via.placeholder.com/50"; 

    // Contenedor texto
    const comentarioTexto = document.createElement("div");
    comentarioTexto.classList.add("comentario-texto");

    const nombre = document.createElement("h4");
    nombre.textContent = "Usuario"; // puedes reemplazar por nombre din√°mico

    const contenido = document.createElement("p");
    contenido.textContent = texto;

    // Botones de acci√≥n
    const acciones = document.createElement("div");
    acciones.style.marginTop = "8px";

    const btnEditar = document.createElement("button");
    btnEditar.textContent = "Editar";
    btnEditar.style.marginRight = "10px";
    btnEditar.style.background = "#ffc107";
    btnEditar.style.border = "none";
    btnEditar.style.padding = "5px 10px";
    btnEditar.style.borderRadius = "6px";
    btnEditar.style.cursor = "pointer";

    btnEditar.onclick = () => {
      const nuevoTexto = prompt("Edita tu comentario:", contenido.textContent);
      if (nuevoTexto !== null && nuevoTexto.trim() !== "") {
        contenido.textContent = nuevoTexto.trim();
      }
    };

    const btnEliminar = document.createElement("button");
    btnEliminar.textContent = "Eliminar";
    btnEliminar.style.background = "#dc3545";
    btnEliminar.style.border = "none";
    btnEliminar.style.padding = "5px 10px";
    btnEliminar.style.borderRadius = "6px";
    btnEliminar.style.cursor = "pointer";
    btnEliminar.style.color = "#fff";

    btnEliminar.onclick = () => {
      lista.removeChild(comentario);
    };

    acciones.appendChild(btnEditar);
    acciones.appendChild(btnEliminar);

    // Insertar todo en el contenedor
    comentarioTexto.appendChild(nombre);
    comentarioTexto.appendChild(contenido);
    comentarioTexto.appendChild(acciones);

    comentario.appendChild(img);
    comentario.appendChild(comentarioTexto);

    lista.appendChild(comentario);

    // Limpiar textarea
    input.value = "";
¬†¬†}

  </script>
</body>
</html>