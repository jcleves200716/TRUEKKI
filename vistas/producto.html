<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>TRUEKKI - Detalle de Producto</title>
  <link rel="stylesheet" href="../css/producto.css">
  <link rel="stylesheet" href="../estilos/barra.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
 <header>
    <div class="header-content">
      
    <div class="logo" onclick="window.location.href='barra.html'">TRUEKKI</div>
      <div class="search-bar">
        <input type="text" placeholder="Buscar productos..." id="search-input">
        <button onclick="searchProducts()"><i class="fas fa-search"></i></button>
      </div>
      <div class="icons">
        <span class="icon menu-btn" onclick="openMenu()"><i class="fas fa-bars"></i></span>
      </div> 
    </div>
  </header>

  <!-- Men√∫ lateral -->
  <div class="sidebar" id="sidebar">
    <span class="close-btn" onclick="closeMenu()">‚úñ</span>
    <div class="user-info">
      <div class="user-avatar" id="sidebar-avatar">US</div>
      <div class="user-name" id="sidebar-name">Usuario</div>
    </div>
    <a href="publicar_producto.html"><i class="fas fa-plus-circle"></i> Publicar</a>
    <a href="#"><i class="fas fa-bell"></i> Notificaciones</a>
    <a href="chat.html"><i class="fas fa-comments"></i> Chats</a>
    <a href="historial.html"><i class="fas fa-history"></i> Historial</a>
    <a href="perfil.html"><i class="fas fa-user"></i> Perfil</a>
    <a href="#"><i class="fas fa-question-circle"></i> Ayuda</a>
    <a href="subastas.html"><i class="fas fa-gavel"></i> Subastas</a>
    <a href="favoritos.html"><i class="fas fa-heart"></i> Mis Favoritos</a>
    <button onclick="logout()" class="cerrar-sesion"><i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n</button>
  </div>

  <!-- Overlay -->
  <div class="overlay" id="overlay" onclick="closeMenu()"></div>

  <!-- Contenido principal -->
  <div class="container" id="product-container">
    <div class="loading-state">
      <i class="fas fa-spinner fa-spin"></i>
      <p>Cargando producto...</p>
    </div>
  </div>

  <!-- Contenedor para centrar los elementos inferiores -->
  <div class="bottom-container">
    <!-- Mensaje al vendedor -->
    <div class="message-box">
      <div class="message-header">
        <span>ENVIAR MENSAJE AL VENDEDOR</span>
        <input type="text" class="message-input" id="message-to-seller" placeholder="Hola, ¬øsigue estando disponible?" value="Hola, ¬øsigue estando disponible?">
      </div>
      <button class="send-btn" id="send-message-btn" onclick="sendMessageToSeller()">
        <i class="fas fa-paper-plane"></i> ENVIAR MENSAJE
      </button>
    </div>
    
    <!-- Perfil del vendedor -->
<div class="perfil">
    <div class="vendedor-info">
        <h3>Informaci√≥n del Vendedor</h3>
        <div id="info-vendedor">
            <div class="loading">Cargando informaci√≥n del vendedor...</div>
        </div>
        <button id="btn-ver-perfil" class="btn-ver-perfil" onclick="verPerfilVendedor()">
            üë§ Ver Perfil Completo del Vendedor
        </button>
    </div>
</div>

    <p class="last-update">
      ULTIMA ACTUALIZACION <span id="last-update-date">22/08/25</span>
    </p>

<!-- ESTE ES EL HTML CORRECTO - COPIAR Y PEGAR COMPLETO -->
<div class="contenedor">
  <!-- Calificaci√≥n -->
  <div class="bloque" style="width:180px;">
    <div id="estrellas-calificacion">
      <span class="estrella" data-valor="1">‚òÖ</span>
      <span class="estrella" data-valor="2">‚òÖ</span>
      <span class="estrella" data-valor="3">‚òÖ</span>
      <span class="estrella" data-valor="4">‚òÖ</span>
      <span class="estrella" data-valor="5">‚òÖ</span>
    </div>
    <div id="puntuacion-promedio">
      <span id="promedio-texto">0.0</span>/5.0
    </div>
    <p id="texto-calificacion">CALIFICAR PRODUCTO</p>
    <p id="total-calificaciones">(0 calificaciones)</p>
  </div>

  <!-- Gr√°fica -->
  <div class="bloque" style="width:300px;">
    <canvas id="grafica-calificaciones"></canvas>
  </div>

  <!-- Intercambios -->
  <div class="bloque" style="width:200px;">
    <p>TOTAL INTERCAMBIOS</p>
    <p class="intercambios">35/100</p>
    <p>ETIQUETAS DE RECONOCIMIENTO</p>
    <p>üèÜ ‚öô üíª</p>
  </div>
</div>
    <!-- Comentarios -->
    <div class="comentarios-container">
      <h2>Comentarios</h2> 
      <div id="comentarios-lista"></div>
      <div class="form-comentario">
        <textarea id="comentario-input" rows="2" placeholder="Escribe un comentario..."></textarea>
        <button onclick="agregarComentario()">Comentar</button>
      </div>
    </div>
  </div>

  <!-- Modal de confirmaci√≥n -->
  <div class="modal" id="messageModal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Mensaje Enviado</h3>
        <button class="close-modal" onclick="closeMessageModal()">√ó</button>
      </div>
      <div class="modal-body">
        <p>Tu mensaje ha sido enviado correctamente al vendedor.</p>
        <div class="modal-actions">
          <button class="btn btn-primary" onclick="goToChat()">
            <i class="fas fa-comments"></i> Ir al Chat
          </button>
          <button class="btn btn-outline" onclick="continueBrowsing()">
            <i class="fas fa-shopping-bag"></i> Seguir Explorando
          </button>
        </div>
      </div>
    </div>
  </div>



<script src="../js/auth.js"></script>
<script>
  // Variables globales
  let currentProduct = null;
  let currentSeller = null;
  let currentUser = null;
  let esFavorito = false;
  let favoritoId = null;
  let calificaciones = [];
  let chart;

  // ‚úÖ NUEVAS VARIABLES PARA CALIFICACIONES
  let calificacionesData = {
      promedios: { promedio: 0, total: 0 },
      distribucion: [0, 0, 0, 0, 0],
      usuarioCalifico: false,
      calificacionUsuario: 0
  };
  let chartCalificaciones = null;

  // ‚úÖ FUNCI√ìN showError (AGREGAR)
  function showError(mensaje) {
      const container = document.getElementById('product-container');
      container.innerHTML = `
          <div class="error-state">
              <i class="fas fa-exclamation-triangle"></i>
              <p>${mensaje}</p>
              <button class="btn-retry" onclick="window.location.reload()">Reintentar</button>
          </div>
      `;
  }

  // Cargar datos al iniciar
  document.addEventListener('DOMContentLoaded', async function() {
    // Verificar autenticaci√≥n
    if (!checkAuth()) {
      return;
    }
    
    // Obtener usuario del localStorage
    currentUser = getCurrentUser();
    
    // Obtener ID del producto de la URL
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('id');
    
    if (!productId) {
      showNotification('No se ha especificado un producto', 'error');
      return;
    }
    
    // Cargar informaci√≥n del producto
    await loadProductData(productId);

    if (currentProduct) {
      await verificarFavorito();


      // ‚úÖ CARGAR CALIFICACIONES
      await cargarCalificacionesProducto();
      inicializarEstrellas();
    }

    function updateUserInfo() {
      document.getElementById('sidebar-avatar').textContent = getInitials(currentUser.nombre);
      document.getElementById('sidebar-name').textContent = currentUser.nombre;
    }

    // Obtener iniciales del nombre
    function getInitials(name) {
      return name.split(' ').map(word => word[0]).join('').toUpperCase().substring(0, 2);
    }
  });

  // ‚úÖ ========== FUNCIONES DE CALIFICACIONES ==========
  // Funci√≥n para cargar las calificaciones del producto
async function cargarCalificacionesProducto() {
    try {
        const usuario = getCurrentUser();
        const url = usuario && usuario.id ? 
            `http://localhost:5000/calificaciones/producto/${currentProduct.id_producto}?idUsuario=${usuario.id}` :
            `http://localhost:5000/calificaciones/producto/${currentProduct.id_producto}`;
            
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.success) {
            calificacionesData = result.data;
            actualizarUIcalificaciones();
            crearGraficaCalificaciones();
        }
    } catch (error) {
        console.error('Error cargando calificaciones:', error); 
    }
}

  // Funci√≥n para calificar el producto
  async function calificarProducto(calificacion) {
      try {
          const usuario = getCurrentUser();
          if (!usuario || !usuario.id) {
              showNotification('Debes iniciar sesi√≥n para calificar productos', 'error');
              return;
          }

          const response = await fetch('http://localhost:5000/calificaciones/calificar', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                  id_producto: currentProduct.id_producto,
                  id_usuario: usuario.id,
                  calificacion: calificacion
              })
          });

          const result = await response.json();
          
          if (result.success) {
              showNotification('¬°Calificaci√≥n enviada!');
              await cargarCalificacionesProducto();
          } else {
              showNotification(result.message, 'error');
          }
      } catch (error) {
          console.error('Error calificando producto:', error);
          showNotification('Error al enviar calificaci√≥n', 'error');
      }
  }


// Funci√≥n para actualizar la UI de calificaciones - VERSI√ìN CORREGIDA
// Funci√≥n para actualizar la UI de calificaciones - VERSI√ìN CORREGIDA
function actualizarUIcalificaciones() {
    console.log('üé® Actualizando UI de calificaciones...');
    
    // Actualizar textos
    const promedioTexto = document.getElementById('promedio-texto');
    const totalCalificaciones = document.getElementById('total-calificaciones');
    const textoCalificacion = document.getElementById('texto-calificacion');
    
    if (promedioTexto) {
        promedioTexto.textContent = calificacionesData.promedios.promedio.toFixed(1);
    }
    
    if (totalCalificaciones) {
        totalCalificaciones.textContent = `(${calificacionesData.promedios.total} calificaciones)`;
    }
    
    if (textoCalificacion) {
        textoCalificacion.textContent = calificacionesData.usuarioCalifico ? 
            '¬°Gracias por calificar!' : 'CALIFICAR PRODUCTO';
    }
    
    // Actualizar estrellas del usuario
    const estrellas = document.querySelectorAll('#estrellas-calificacion .estrella');
    console.log('Estrellas encontradas para actualizar:', estrellas.length);
    
    estrellas.forEach(estrella => {
        const valor = parseInt(estrella.getAttribute('data-valor'));
        const estaSeleccionada = valor <= calificacionesData.calificacionUsuario;
        
        console.log(`Estrella ${valor}: seleccionada = ${estaSeleccionada}`);
        
        if (estaSeleccionada) {
            estrella.classList.add('seleccionada');
            estrella.style.color = '#ffc107';
        } else {
            estrella.classList.remove('seleccionada');
            estrella.style.color = '#ddd';
        }
    });
    
    // ‚úÖ SOLO LLAMAR A LA FUNCI√ìN, NO DUPLICAR EL C√ìDIGO
    crearGraficaCalificaciones();
}

  // Funci√≥n para crear/actualizar la gr√°fica de calificaciones
      const ctx = document.getElementById('grafica-calificaciones').getContext('2d');
      
      if (chartCalificaciones) {
          chartCalificaciones.destroy();
      }

      chartCalificaciones = new Chart(ctx, {
          type: 'bar',
          data: {
              labels: ['1‚òÖ', '2‚òÖ', '3‚òÖ', '4‚òÖ', '5‚òÖ'],
              datasets: [{
                  label: 'Calificaciones',
                  data: calificacionesData.distribucion,
                  backgroundColor: [
                      '#ff6b6b',
                      '#ffa726',
                      '#ffee58',
                      '#9ccc65',
                      '#66bb6a'
                  ],
                  borderColor: [
                      '#ff5252',
                      '#ff9800',
                      '#fdd835',
                      '#8bc34a',
                      '#4caf50'
                  ],
                  borderWidth: 1
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  legend: {
                      display: false
                  },
                  tooltip: {
                      callbacks: {
                          label: function(context) {
                              return `${context.parsed.y} calificaciones`;
                          }
                      }
                  }
              },
              scales: {
                  y: {
                      beginAtZero: true,
                      ticks: {
                          stepSize: 1,
                          precision: 0
                      },
                      title: {
                          display: true,
                          text: 'Cantidad'
                      }
                  },
                  x: {
                      title: {
                          display: true,
                          text: 'Estrellas'
                      }
                  }
              }
          }
      });

  // Inicializar eventos de las estrellas
 // Inicializar eventos de las estrellas
function inicializarEstrellas() {
    console.log('üîÑ Inicializando estrellas...');
    
    const estrellas = document.querySelectorAll('#estrellas-calificacion .estrella');
    console.log('Estrellas encontradas:', estrellas.length);
    
    if (estrellas.length === 0) {
        console.error('‚ùå No se encontraron estrellas para inicializar');
        return;
    }
    
    estrellas.forEach(estrella => {
        // Limpiar eventos anteriores
        const nuevaEstrella = estrella.cloneNode(true);
        estrella.parentNode.replaceChild(nuevaEstrella, estrella);
    });
    
    // Volver a obtener las estrellas despu√©s del clone
    const nuevasEstrellas = document.querySelectorAll('#estrellas-calificacion .estrella');
    
    nuevasEstrellas.forEach(estrella => {
        // Hover
        estrella.addEventListener('mouseenter', function() {
            if (!calificacionesData.usuarioCalifico) {
                const valor = parseInt(this.getAttribute('data-valor'));
                resaltarEstrellas(valor);
            }
        });

        // Mouse out
        estrella.addEventListener('mouseleave', function() {
            if (!calificacionesData.usuarioCalifico) {
                resetearEstrellasHover();
            }
        });

        // Click
        estrella.addEventListener('click', function() {
            console.log('‚≠ê Estrella clickeada:', this.getAttribute('data-valor'));
            if (!calificacionesData.usuarioCalifico) {
                const valor = parseInt(this.getAttribute('data-valor'));
                calificarProducto(valor);
            } else {
                showNotification('Ya has calificado este producto', 'info');
            }
        });
    });
    
    console.log('‚úÖ Estrellas inicializadas correctamente');
}

// Funciones auxiliares para las estrellas
function resaltarEstrellas(hastaValor) {
    const estrellas = document.querySelectorAll('#estrellas-calificacion .estrella');
    estrellas.forEach(estrella => {
        const valor = parseInt(estrella.getAttribute('data-valor'));
        if (valor <= hastaValor) {
            estrella.style.color = '#ffc107';
        } else {
            estrella.style.color = '#ddd';
        }
    });
}

function resetearEstrellasHover() {
    const estrellas = document.querySelectorAll('#estrellas-calificacion .estrella');
    estrellas.forEach(estrella => {
        const valor = parseInt(estrella.getAttribute('data-valor'));
        const estaSeleccionada = valor <= calificacionesData.calificacionUsuario;
        
        if (!estaSeleccionada) {
            estrella.style.color = '#ddd';
        }
    });
}
  // Funci√≥n para crear/actualizar la gr√°fica de calificaciones
function crearGraficaCalificaciones() {
    console.log('üìä Creando gr√°fica de calificaciones...');
    
    const ctx = document.getElementById('grafica-calificaciones');
    if (!ctx) {
        console.error('‚ùå No se encontr√≥ el elemento canvas para la gr√°fica');
        return;
    }
    
    // Destruir gr√°fica anterior si existe
    if (chartCalificaciones) {
        chartCalificaciones.destroy();
    }
    
    try {
        chartCalificaciones = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['1‚òÖ', '2‚òÖ', '3‚òÖ', '4‚òÖ', '5‚òÖ'],
                datasets: [{
                    label: 'Calificaciones',
                    data: calificacionesData.distribucion,
                    backgroundColor: [
                        '#ff6b6b',
                        '#ffa726', 
                        '#ffee58',
                        '#9ccc65',
                        '#66bb6a'
                    ],
                    borderColor: [
                        '#ff5252',
                        '#ff9800',
                        '#fdd835', 
                        '#8bc34a',
                        '#4caf50'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.parsed.y} calificaciones`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1,
                            precision: 0
                        },
                        title: {
                            display: true,
                            text: 'Cantidad'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Estrellas'
                        }
                    }
                }
            }
        });
        
        console.log('‚úÖ Gr√°fica creada exitosamente');
    } catch (error) {
        console.error('‚ùå Error creando gr√°fica:', error);
    }
}
  // Funciones auxiliares para las estrellas
  function resaltarEstrellas(hastaValor) {
      const estrellas = document.querySelectorAll('#estrellas-calificacion .estrella');
      estrellas.forEach(estrella => {
          const valor = parseInt(estrella.getAttribute('data-valor'));
          estrella.classList.toggle('hover', valor <= hastaValor);
      });
  }

  function resetearEstrellasHover() {
      const estrellas = document.querySelectorAll('#estrellas-calificacion .estrella');
      estrellas.forEach(estrella => {
          estrella.classList.remove('hover');
      });
  }

  // ‚úÖ ========== FIN FUNCIONES CALIFICACIONES ==========

  // Men√∫ lateral
  const sidebar = document.getElementById("sidebar");
  const overlay = document.getElementById("overlay");

  function openMenu() {
    sidebar.style.width = "280px";
    overlay.style.display = "block";
  }

  function closeMenu() {
    sidebar.style.width = "0";
    overlay.style.display = "none";
  }

  // ========== FUNCIONALIDAD DE MENSAJES AL VENDEDOR ==========

  // Enviar mensaje al vendedor
  async function sendMessageToSeller() {
    try {
      const messageInput = document.getElementById('message-to-seller');
      const message = messageInput.value.trim();
      const sendBtn = document.getElementById('send-message-btn');
      
      if (!message) {
        showNotification('Por favor escribe un mensaje', 'error');
        return;
      }

      if (!currentUser || !currentUser.id) {
        showNotification('Debes iniciar sesi√≥n para enviar mensajes', 'error');
        window.location.href = 'login.html';
        return;
      }

      // Deshabilitar bot√≥n mientras se env√≠a
      sendBtn.disabled = true;
      sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ENVIANDO...';

      console.log('üìç Iniciando conversaci√≥n con vendedor:', currentSeller.id);
      
      // 1. Crear o obtener conversaci√≥n
      const conversationResponse = await fetch('http://localhost:5000/chat/conversacion', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          id_usuario1: currentUser.id,
          id_usuario2: currentSeller.id
        })
      });

      if (!conversationResponse.ok) {
        throw new Error(`Error HTTP: ${conversationResponse.status}`);
      }

      const conversationResult = await conversationResponse.json();
      
      if (!conversationResult.success) {
        throw new Error(conversationResult.message);
      }

      const conversation = conversationResult.conversacion;
      console.log('‚úÖ Conversaci√≥n:', conversation);

      // 2. Enviar mensaje
      const messageResponse = await fetch('http://localhost:5000/chat/mensaje', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          id_conversacion: conversation.id_conversacion,
          id_remitente: currentUser.id,
          mensaje: message
        })
      });

      if (!messageResponse.ok) {
        throw new Error(`Error HTTP: ${messageResponse.status}`);
      }

      const messageResult = await messageResponse.json();
      
      if (!messageResult.success) {
        throw new Error(messageResult.message);
      }

      console.log('‚úÖ Mensaje enviado correctamente');
      
      // Mostrar modal de √©xito
      showMessageModal();
      
    } catch (error) {
      console.error('‚ùå Error enviando mensaje:', error);
      showNotification('Error al enviar mensaje: ' + error.message, 'error');
      
      // Rehabilitar bot√≥n
      const sendBtn = document.getElementById('send-message-btn');
      sendBtn.disabled = false;
      sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> ENVIAR MENSAJE';
    }
  }

  // Mostrar modal de mensaje enviado
  function showMessageModal() {
    const modal = document.getElementById('messageModal');
    modal.style.display = 'flex';
    
    // Rehabilitar bot√≥n
    const sendBtn = document.getElementById('send-message-btn');
    sendBtn.disabled = false;
    sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> ENVIAR MENSAJE';
  }

  // Cerrar modal
  function closeMessageModal() {
    const modal = document.getElementById('messageModal');
    modal.style.display = 'none';
  }

  // Ir al chat despu√©s de enviar mensaje
  function goToChat() {
    closeMessageModal();
    window.location.href = 'chat.html';
  }

  // Seguir explorando productos
  function continueBrowsing() {
    closeMessageModal();
  }

  // ========== FUNCIONALIDAD DEL PERFIL DEL VENDEDOR ==========

  // Funci√≥n para ver el perfil del vendedor
  function verPerfilVendedor() {
      if (!currentSeller || !currentSeller.id) {
          console.error('No hay informaci√≥n del vendedor disponible');
          showNotification('Error: No se pudo cargar el perfil del vendedor', 'error');
          return;
      }
      
      // Obtener el ID del producto actual de la URL
      const urlParams = new URLSearchParams(window.location.search);
      const productId = urlParams.get('id');
      
      if (productId) {
          window.location.href = `perfil-vendedor.html?id_producto_origen=${productId}`;
      } else {
          window.location.href = `perfil-vendedor.html?id_vendedor=${currentSeller.id}`;
      }
  }

  // Funci√≥n para cargar y mostrar informaci√≥n del vendedor
  async function cargarInformacionVendedor(vendedor) {
      try {
          const infoVendedor = document.getElementById('info-vendedor');
          
          if (!vendedor) {
              infoVendedor.innerHTML = '<div class="error">No se pudo cargar la informaci√≥n del vendedor</div>';
              return;
          }

          // Obtener informaci√≥n completa del vendedor
          const response = await fetch(`http://localhost:5000/usuario/${vendedor.id}`);
          const result = await response.json();
          
          let vendedorCompleto = vendedor;
          if (result.success) {
              vendedorCompleto = { ...vendedor, ...result.usuario };
          }

          infoVendedor.innerHTML = `
              <div class="vendedor-details">
                  <div class="vendedor-detail-item">
                      <i>üë§</i> 
                      <strong>Nombre:</strong> ${vendedorCompleto.nombre}
                      ${vendedorCompleto.verificado ? '<span class="verificado-badge">‚úì Verificado</span>' : ''}
                  </div>
                  <div class="vendedor-detail-item">
                      <i>üìß</i> 
                      <strong>Email:</strong> ${vendedorCompleto.email || 'No disponible'}
                  </div>
                  <div class="vendedor-detail-item">
                      <i>üì±</i> 
                      <strong>Tel√©fono:</strong> ${vendedorCompleto.numero_telefono || 'No disponible'}
                  </div>
                  ${vendedorCompleto.fecha_registro ? `
                  <div class="vendedor-detail-item">
                      <i>üìÖ</i> 
                      <strong>Miembro desde:</strong> ${formatearFecha(vendedorCompleto.fecha_registro)}
                  </div>
                  ` : ''}
              </div>
          `;

      } catch (error) {
          console.error('Error cargando informaci√≥n del vendedor:', error);
          document.getElementById('info-vendedor').innerHTML = `
              <div class="vendedor-details">
                  <div class="vendedor-detail-item">
                      <i>üë§</i> <strong>Nombre:</strong> ${vendedor.nombre}
                  </div>
                  <div class="vendedor-detail-item">
                      <i>üìß</i> <strong>Email:</strong> ${vendedor.email || 'No disponible'}
                  </div>
              </div>
          `;
      }
  }

  // Funci√≥n auxiliar para formatear fechas
  function formatearFecha(fechaString) {
      try {
          const fecha = new Date(fechaString);
          return fecha.toLocaleDateString('es-ES', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
          });
      } catch (error) {
          return 'Fecha no disponible';
      }
  }

  // ========== FUNCIONALIDAD EXISTENTE DEL PRODUCTO ==========

  // Cargar datos del producto desde la API
  async function loadProductData(productId) {
    try {
      console.log('Cargando producto ID:', productId);
      
      const response = await fetch(`http://localhost:5000/producto/${productId}`);
      
      if (!response.ok) {
        throw new Error(`Error HTTP: ${response.status}`);
      }
      
      const result = await response.json();
      console.log('Respuesta del servidor:', result);
      
      if (result.success) {
        currentProduct = result.producto;
        currentSeller = result.vendedor;
        renderProduct(currentProduct, currentSeller);
        // ‚úÖ COMENTAR ESTA L√çNEA TEMPORALMENTE
        // updateSellerInfo(currentSeller);
      } else {
        // ‚úÖ USAR showNotification EN VEZ DE showError
        showNotification('Error: ' + result.message, 'error');
      }
    } catch (error) {
      console.error('Error cargando producto:', error);
      // ‚úÖ USAR showNotification EN VEZ DE showError
      showNotification('Error de conexi√≥n. Verifica que el servidor est√© ejecut√°ndose.', 'error');
    }
  }

  // Actualizar informaci√≥n del vendedor en la UI
  function updateSellerInfo(seller) {
    // ‚úÖ COMENTAR O ELIMINAR ESTA L√çNEA
    // document.getElementById('seller-name').textContent = seller.nombre + '.';
    console.log('Vendedor:', seller.nombre);
  }

  // Renderizar producto
  function renderProduct(product, seller) {
    const container = document.getElementById('product-container');
    
    container.innerHTML = `
      <!-- Galer√≠a lateral -->
      <div class="gallery">
        ${product.foto ? 
          `<img src="http://localhost:5000/imagen-producto/${product.id_producto}" 
               alt="${product.titulo}" 
               onerror="handleImageError(this)">` : 
          '<div class="no-image">Imagen no disponible</div>'
        }
      </div>

      <!-- Imagen principal -->
      <div class="main-image">
        ${product.foto ? 
          `<img src="http://localhost:5000/imagen-producto/${product.id_producto}" 
               alt="${product.titulo}"
               onerror="handleImageError(this)">` : 
          '<div class="no-image">Imagen no disponible</div>'
        }
      </div>

      <!-- Detalles -->
      <div class="details">
        <h2>${product.titulo}</h2>
        <p>${product.descripcion}</p>

        <div class="price">
          <b>Precio:</b> ${product.precio ? `$${parseInt(product.precio).toLocaleString()}` : 'Negociable'}
        </div>
        
        <p><b>Ubicaci√≥n:</b> ${product.ciudad}, ${product.barrio}</p>
        
        <p><b>Vendedor:</b> ${seller.nombre}</p>

        <div class="tags">
          <span class="tag">${product.categoria}</span>
          <span class="tag">${product.estado}</span>
          <span class="tag">${product.contacto === 'whatsapp' ? 'WhatsApp' : 'Mensaje'}</span>
        </div>
        
        <div class="tags">
          <span class="tag2">venta</span>
          <span class="tag2">trueque</span>
          <span class="tag2">venta/trueque</span>
        </div>

        <div class="btns">
          <button onclick="addToWishlist(${product.id_producto})">
            <i class="fas fa-heart"></i> Lista deseos
          </button>
          <button onclick="shareProduct()">
            <i class="fas fa-share"></i> Compartir
          </button>
        </div>

        <!-- SECCI√ìN DE FAVORITOS -->
        <div class="favorite-section">
          <button id="btn-favorito" class="btn-favorito" onclick="toggleFavorito()">
            <i class="far fa-heart"></i> Agregar a Favoritos
          </button>
        </div>
      </div>
    `;

    setTimeout(verificarFavorito, 100);
    cargarInformacionVendedor(seller);
  }

  // ========== FUNCIONES AUXILIARES ==========

  // Manejar error de imagen
  function handleImageError(img) {
    img.style.display = 'none';
    img.parentElement.innerHTML = '<div class="no-image">Imagen no disponible</div>';
  }

  // Mostrar notificaci√≥n
  function showNotification(mensaje, tipo = 'success') {
    const notificacion = document.createElement('div');
    notificacion.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      background: ${tipo === 'success' ? '#28a745' : '#dc3545'};
      color: white;
      border-radius: 5px;
      z-index: 1000;
      font-family: Arial, sans-serif;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    notificacion.textContent = mensaje;
    
    document.body.appendChild(notificacion);
    
    setTimeout(() => {
      if (document.body.contains(notificacion)) {
        document.body.removeChild(notificacion);
      }
    }, 3000);
  }

  // Funci√≥n para verificar si el producto est√° en favoritos
  async function verificarFavorito() {
    try {
      const usuario = getCurrentUser();
      if (!usuario || !usuario.id) return;

      const response = await fetch(`http://localhost:5000/favoritos/verificar/${usuario.id}/${currentProduct.id_producto}`);
      const result = await response.json();
      
      if (result.success) {
        esFavorito = result.esFavorito;
        actualizarBotonFavorito();
      }
    } catch (error) {
      console.error('Error verificando favorito:', error);
    }
  }

  // Funci√≥n para alternar favorito
  async function toggleFavorito() {
    try {
      const usuario = getCurrentUser();
      if (!usuario || !usuario.id) {
        showNotification('Debes iniciar sesi√≥n para agregar favoritos', 'error');
        window.location.href = '../vistas/login.html';
        return;
      }

      if (esFavorito) {
        await eliminarFavorito();
      } else {
        await agregarFavorito();
      }
    } catch (error) {
      console.error('Error al manejar favorito:', error);
      showNotification('Error al procesar la acci√≥n', 'error');
    }
  }

  // Funci√≥n para agregar a favoritos
  async function agregarFavorito() {
    const usuario = getCurrentUser();
    
    const response = await fetch('http://localhost:5000/favoritos/agregar', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        id_usuario: usuario.id,
        id_producto: currentProduct.id_producto
      })
    });

    const result = await response.json();
    
    if (result.success) {
      esFavorito = true;
      favoritoId = result.id_favorito;
      actualizarBotonFavorito();
      showNotification('Producto agregado a favoritos');
    } else {
      showNotification(result.message, 'error');
    }
  }

  // Funci√≥n para eliminar de favoritos
  async function eliminarFavorito() {
    const usuario = getCurrentUser();
    
    const response = await fetch('http://localhost:5000/favoritos/eliminar', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        id_usuario: usuario.id,
        id_producto: currentProduct.id_producto
      })
    });

    const result = await response.json();
    
    if (result.success) {
      esFavorito = false;
      favoritoId = null;
      actualizarBotonFavorito();
      showNotification('Producto eliminado de favoritos');
    } else {
      showNotification(result.message, 'error');
    }
  }

  // Funci√≥n para actualizar la apariencia del bot√≥n
  function actualizarBotonFavorito() {
    const boton = document.getElementById('btn-favorito');
    if (!boton) return;

    if (esFavorito) {
      boton.innerHTML = '<i class="fas fa-heart"></i> Eliminar de Favoritos';
      boton.classList.add('favorito-activo');
    } else {
      boton.innerHTML = '<i class="far fa-heart"></i> Agregar a Favoritos';
      boton.classList.remove('favorito-activo');
    }
  }

  function agregarComentario() {
    const input = document.getElementById("comentario-input");
    const texto = input.value.trim();
    if (texto === "") return;
    const lista = document.getElementById("comentarios-lista");
  
    const comentario = document.createElement("div");
    comentario.classList.add("comentario");
    
    const img = document.createElement("img");
    img.src = "https://i.pinimg.com/736x/d2/50/af/d250af5bf078a388b23d9916b575dc48.jpg";  

    const comentarioTexto = document.createElement("div");
    comentarioTexto.classList.add("comentario-texto");
    const nombre = document.createElement("h4");
    nombre.textContent = "Usuario";
    const contenido = document.createElement("p");
    contenido.textContent = texto;

    const acciones = document.createElement("div");
    acciones.classList.add("comentario-acciones");

    const btnEditar = document.createElement("button");
    btnEditar.textContent = "Editar";
    btnEditar.classList.add("btn-editar");
    btnEditar.onclick = () => {
      const nuevoTexto = prompt("Edita tu comentario:", contenido.textContent);
      if (nuevoTexto !== null && nuevoTexto.trim() !== "") {
        contenido.textContent = nuevoTexto.trim();
      } 
    };
    
    const btnEliminar = document.createElement("button");
    btnEliminar.textContent = "Eliminar";
    btnEliminar.classList.add("btn-eliminar");
    btnEliminar.onclick = () => {
      lista.removeChild(comentario);
    };

    acciones.appendChild(btnEditar);
    acciones.appendChild(btnEliminar);

    comentarioTexto.appendChild(nombre);
    comentarioTexto.appendChild(contenido);
    comentarioTexto.appendChild(acciones);

    comentario.appendChild(img);
    comentario.appendChild(comentarioTexto);

    lista.appendChild(comentario);

    input.value = "";
  }


  // Funci√≥n de debug temporal
function debugCompleto() {
    console.log('=== DEBUG COMPLETO ===');
    
    // 1. Verificar elementos HTML
    console.log('1. Elementos HTML:');
    console.log('- Estrellas contenedor:', document.getElementById('estrellas-calificacion'));
    console.log('- Estrellas individuales:', document.querySelectorAll('#estrellas-calificacion .estrella').length);
    console.log('- Promedio texto:', document.getElementById('promedio-texto'));
    console.log('- Total calificaciones:', document.getElementById('total-calificaciones'));
    console.log('- Texto calificaci√≥n:', document.getElementById('texto-calificacion'));
    console.log('- Canvas gr√°fica:', document.getElementById('grafica-calificaciones'));
    
    // 2. Verificar datos
    console.log('2. Datos calificaciones:', calificacionesData);
    
    // 3. Verificar CSS
    console.log('3. Estilos aplicados:');
    const primeraEstrella = document.querySelector('#estrellas-calificacion .estrella');
    if (primeraEstrella) {
        const estilos = window.getComputedStyle(primeraEstrella);
        console.log('- Color estrella:', estilos.color);
        console.log('- Tama√±o fuente:', estilos.fontSize);
    }
    
    console.log('=== FIN DEBUG ===');
}

// Llama esta funci√≥n despu√©s de cargar todo
setTimeout(debugCompleto, 2000);
</script>
</body>
</html>