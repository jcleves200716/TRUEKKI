<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRUEKKI - Mi Perfil</title>
    <link rel="stylesheet" href="../css/perfil.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <header>
        <div class="container header-content">
            <div class="logo" onclick="window.location.href='barra.html'">TRUEKKI</div>
            <div class="search-bar">    
                <input type="text" placeholder="Buscar productos...">
            </div>
            <div class="user-actions">
                <a href="#" onclick="showSection('profile')">Mi cuenta</a>
                <a href="#" onclick="logout()">Salir</a>
            </div>
        </div>
    </header>
    
    <nav>
        <div class="container">
            <ul class="nav-links">
                <li><a onclick="window.location.href='barra.html'">Inicio</a></li>
                <li><a onclick="window.location.href='barra.html'">Productos</a></li>
                <li><a href="#">Categorías</a></li>
                <li><a href="#">Ofertas</a></li>
                <li><a href="#">Contacto</a></li>
            </ul>
        </div>
    </nav>
    
    <div class="container main-content">
        <aside class="sidebar">
            <div class="user-profile">
                <div class="user-avatar" id="user-avatar">US</div>
                <div class="user-name" id="user-name">Cargando...</div>
                <div class="user-bio" id="user-bio">Usuario de TRUEKKI</div>
            </div>
            
            <ul class="sidebar-menu">
                <li><a onclick="showSection('profile')" class="active">Mi perfil</a></li>
                <li><a onclick="showSection('my-products')">Mis productos</a></li>
                <li><a onclick="showSection('favorites')">Favoritos</a></li>
                <li><a onclick="showSection('history')">Historial</a></li>
                <li><a onclick="showSection('messages')">Mensajes</a></li>
                <li><a href="#">Configuración</a></li>
            </ul>
        </aside>
        
        <!-- Sección de Perfil -->
        <section id="profile-section" class="content-section active">
            <h1 class="page-title">Mi Perfil</h1>
            
            <div class="profile-form">
                <div class="form-group">
                    <label for="name">Nombre completo</label>
                    <input type="text" id="name" placeholder="Cargando...">
                </div>
                
                <div class="form-group">
                    <label for="email">Correo electrónico</label>
                    <input type="email" id="email" placeholder="Cargando..." disabled>
                </div>
                
                <div class="form-group">
                    <label for="phone">Teléfono</label>
                    <input type="tel" id="phone" placeholder="Cargando...">
                </div>
                
                <div class="form-group">
                    <label for="bio">Biografía</label>
                    <textarea id="bio" placeholder="Cuéntanos algo sobre ti..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="location">Ubicación</label>
                    <input type="text" id="location" placeholder="Cargando...">
                </div>
                
                <button class="btn btn-primary" onclick="updateProfile()">Guardar cambios</button>
                <div id="profile-message" class="message-hidden"></div>
            </div>
        </section>
        
        <!-- Sección de Mis Productos -->
        <section id="my-products-section" class="content-section">
            <h1 class="page-title">Mis Productos</h1>
            
            <div class="products-grid" id="products-grid">
                <div class="loading-state">Cargando productos...</div>
            </div>
            
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-primary" onclick="window.location.href='publicar_producto.html'">Agregar nuevo producto</button>
            </div>
        </section>
        
        <!-- Sección de Favoritos -->
        <section id="favorites-section" class="content-section">
            <h1 class="page-title">Mis Favoritos</h1>
            
            <div class="favorites-grid">
                <div class="empty-state">
                    <i class="fas fa-heart"></i>
                    <h3>No tienes productos favoritos</h3>
                    <p>Cuando agregues productos a favoritos, aparecerán aquí</p>
                </div>
            </div>
        </section>
        
        <!-- Sección de Historial -->
        <section id="history-section" class="content-section">
            <h1 class="page-title">Historial de intercambios y ventas</h1>
            
            <div class="history-items">
                <div class="empty-state">
                    <i class="fas fa-history"></i>
                    <h3>No hay historial disponible</h3>
                    <p>Tu historial de intercambios y ventas aparecerá aquí</p>
                </div>
            </div>
        </section>
        
        <!-- Sección de Mensajes -->
        <section id="messages-section" class="content-section">
            <h1 class="page-title">Mensajes</h1>
            
            <div class="messages-container">
                <div class="empty-state">
                    <i class="fas fa-comments"></i>
                    <h3>No tienes mensajes</h3>
                    <p>Cuando recibas mensajes de otros usuarios, aparecerán aquí</p>
                </div>
            </div>
        </section>
    </div>
    
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>TRUEKKI</h3>
                    <p>Plataforma de intercambios y ventas de productos únicos.</p>
                </div>
                
                <div class="footer-section">
                    <h3>Enlaces rápidos</h3>
                    <ul>
                        <li><a href="#">Acerca de nosotros</a></li>
                        <li><a href="#">Términos y condiciones</a></li>
                        <li><a href="#">Política de privacidad</a></li>
                        <li><a href="#">Contacto</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h3>Categorías populares</h3>
                    <ul>
                        <li><a href="#">Tecnología</a></li>
                        <li><a href="#">Libros</a></li>
                        <li><a href="#">Ropa</a></li>
                        <li><a href="#">Hogar</a></li>
                    </ul>
                </div>
            </div>
            
            <div class="copyright">
                &copy; 2023 TRUEKKI - Todos los derechos reservados
            </div>
        </div>
    </footer>

    <!-- Script de autenticación -->
    <script src="../js/auth.js"></script>
    
    <script>
        // Variables globales
        let currentUser = null;
        let userProducts = [];

        // Cargar datos del usuario al iniciar
        document.addEventListener('DOMContentLoaded', async function() {
            // Verificar autenticación
            if (!checkAuth()) {
                return;
            }
            
            // Obtener usuario del localStorage
            currentUser = getCurrentUser();
            console.log('Usuario actual:', currentUser);
            
            // Cargar información del usuario
            await loadUserData();
            
            // Cargar productos del usuario
            await loadUserProducts();
        });

        // Cargar datos del usuario desde la API
        async function loadUserData() {
            try {
                console.log('Cargando datos del usuario ID:', currentUser.id);
                
                const response = await fetch(`http://localhost:5000/usuario/${currentUser.id}`);
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Datos del usuario recibidos:', result);
                
                if (result.success) {
                    const usuario = result.usuario;
                    
                    // Actualizar UI con datos del usuario
                    document.getElementById('user-avatar').textContent = getInitials(usuario.nombre);
                    document.getElementById('user-name').textContent = usuario.nombre;
                    document.getElementById('user-bio').textContent = usuario.bio || 'Usuario de TRUEKKI';
                    
                    // Llenar formulario de perfil
                    document.getElementById('name').value = usuario.nombre;
                    document.getElementById('email').value = usuario.email;
                    document.getElementById('phone').value = usuario.numero_telefono || '';
                    document.getElementById('bio').value = usuario.bio || '';
                    document.getElementById('location').value = usuario.direccion || '';
                    
                } else {
                    throw new Error(result.message || 'Error al cargar datos del usuario');
                }
            } catch (error) {
                console.error('Error cargando datos del usuario:', error);
                showMessage('Error al cargar perfil: ' + error.message, 'error');
            }
        }

        // Cargar productos del usuario
        async function loadUserProducts() {
            try {
                console.log('Cargando productos del usuario ID:', currentUser.id);
                
                const response = await fetch(`http://localhost:5000/productos-usuario/${currentUser.id}`);
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Productos recibidos:', result);
                
                if (result.success) {
                    userProducts = result.productos;
                    renderUserProducts();
                } else {
                    throw new Error(result.message || 'Error al cargar productos');
                }
            } catch (error) {
                console.error('Error cargando productos del usuario:', error);
                showMessage('Error al cargar productos: ' + error.message, 'error');
                
                // Mostrar estado vacío
                const productsGrid = document.getElementById('products-grid');
                productsGrid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error al cargar productos</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // Renderizar productos del usuario
        function renderUserProducts() {
            const productsGrid = document.getElementById('products-grid');
            
            if (userProducts.length === 0) {
                productsGrid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-box-open"></i>
                        <h3>No tienes productos publicados</h3>
                        <p>Comienza a publicar productos para verlos aquí</p>
                        <button class="btn btn-primary" onclick="window.location.href='publicar_producto.html'">Publicar primer producto</button>
                    </div>
                `;
                return;
            }
            
            productsGrid.innerHTML = userProducts.map(product => `
                <div class="product-card" id="product-${product.id_producto}">
                    <div class="product-image">
                        ${product.foto ? 
                            `<img src="http://localhost:5000/imagen-producto/${product.id_producto}" alt="${product.titulo}" onerror="this.style.display='none'">` : 
                            '<i class="fas fa-image"></i>'
                        }
                    </div>
                    <div class="product-info">
                        <div class="product-title">${product.titulo}</div>
                        <div class="product-category">${product.categoria}</div>
                        <div class="product-price">${product.precio ? `$${parseInt(product.precio).toLocaleString()}` : 'Intercambio'}</div>
                        <div class="product-stats">
                            <span class="product-state">${product.estado}</span>
                            <span class="product-intercambios">${product.intercambios_realizados || 0} intercambios</span>
                        </div>
                        <div class="product-actions">
                            <button class="btn btn-outline" onclick="editProduct(${product.id_producto})">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="btn btn-primary" onclick="viewProduct(${product.id_producto})">
                                <i class="fas fa-eye"></i> Ver
                            </button>
                            <button class="btn btn-danger" onclick="confirmDeleteProduct(${product.id_producto})">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Obtener iniciales del nombre
        function getInitials(name) {
            return name.split(' ').map(word => word[0]).join('').toUpperCase().substring(0, 2);
        }

        // Actualizar perfil del usuario
        async function updateProfile() {
            const nombre = document.getElementById('name').value;
            const telefono = document.getElementById('phone').value;
            const bio = document.getElementById('bio').value;
            const ubicacion = document.getElementById('location').value;
            
            // Validación básica
            if (!nombre.trim()) {
                showMessage('El nombre es obligatorio', 'error');
                return;
            }
            
            try {
                showMessage('Guardando cambios...', 'loading');
                
                const response = await fetch(`http://localhost:5000/usuario/${currentUser.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        nombre: nombre,
                        numero_telefono: telefono,
                        direccion: ubicacion,
                        bio: bio
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('Perfil actualizado correctamente', 'success');
                    
                    // Actualizar UI
                    document.getElementById('user-name').textContent = nombre;
                    document.getElementById('user-bio').textContent = bio || 'Usuario de TRUEKKI';
                    document.getElementById('user-avatar').textContent = getInitials(nombre);
                    
                    // Actualizar usuario en localStorage
                    const updatedUser = {...currentUser, nombre: nombre};
                    localStorage.setItem('usuario', JSON.stringify(updatedUser));
                    currentUser = updatedUser;
                } else {
                    throw new Error(result.message || 'Error al actualizar perfil');
                }
            } catch (error) {
                console.error('Error actualizando perfil:', error);
                showMessage('Error al actualizar perfil: ' + error.message, 'error');
            }
        }

        // Función para cambiar entre secciones
        function showSection(sectionId) {
            // Ocultar todas las secciones
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Mostrar sección seleccionada
            document.getElementById(sectionId + '-section').classList.add('active');
            
            // Actualizar menú activo
            document.querySelectorAll('.sidebar-menu a').forEach(link => {
                link.classList.remove('active');
            });
            
            const activeLink = document.querySelector(`.sidebar-menu a[onclick="showSection('${sectionId}')"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
            
            // Cargar productos si se muestra la sección de mis productos
            if (sectionId === 'my-products') {
                loadUserProducts();
            }
        }

        // Ver producto
        function viewProduct(productId) {
            window.location.href = `producto.html?id=${productId}`;
        }

        // Editar producto
        function editProduct(productId) {
            window.location.href = `editar_producto.html?id=${productId}`;
        }

        // Confirmar eliminación de producto
        function confirmDeleteProduct(productId) {
            const productElement = document.getElementById(`product-${productId}`);
            if (!productElement) {
                showMessage('Error: No se pudo encontrar el producto', 'error');
                return;
            }
            
            const productTitle = productElement.querySelector('.product-title').textContent;
            
            if (confirm(`¿Estás seguro de que quieres eliminar el producto "${productTitle}"?\n\nEsta acción no se puede deshacer.`)) {
                deleteProduct(productId);
            }
        }

        // Eliminar producto - ADAPTADA A TU BACKEND (POST /producto/:id/eliminar)
    // Eliminar producto - VERSIÓN CON DELETE
async function deleteProduct(productId) {
    try {
        console.log('Eliminando producto ID:', productId);
        
        const deleteBtn = document.querySelector(`#product-${productId} .btn-danger`);
        if (deleteBtn) {
            deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Eliminando...';
            deleteBtn.disabled = true;
        }
        
        // Usar DELETE en lugar de POST
        const response = await fetch(`http://localhost:5000/producto/${productId}`, {
            method: 'DELETE',  // Cambiado a DELETE
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        console.log('Respuesta del servidor:', response.status);
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Error HTTP: ${response.status} - ${errorText}`);
        }
        
        const result = await response.json();
        console.log('Resultado de eliminación:', result);
        
        if (result.success) {
            showMessage('Producto eliminado correctamente', 'success');
            
            const productElement = document.getElementById(`product-${productId}`);
            if (productElement) {
                productElement.style.opacity = '0';
                productElement.style.transform = 'translateX(-100px)';
                productElement.style.transition = 'all 0.5s ease';
                
                setTimeout(() => {
                    productElement.remove();
                    
                    const remainingProducts = document.querySelectorAll('.product-card');
                    if (remainingProducts.length === 0) {
                        loadUserProducts();
                    }
                }, 500);
            }
        } else {
            throw new Error(result.message || 'Error del servidor');
        }
        
    } catch (error) {
        console.error('Error eliminando producto:', error);
        showMessage('Error al eliminar producto: ' + error.message, 'error');
        
        const deleteBtn = document.querySelector(`#product-${productId} .btn-danger`);
        if (deleteBtn) {
            deleteBtn.innerHTML = '<i class="fas fa-trash"></i> Eliminar';
            deleteBtn.disabled = false;
        }
    }
}


        // Mostrar mensaje
        function showMessage(text, type) {
            // Buscar elemento existente o crear uno nuevo
            let messageElement = document.getElementById('global-message');
            if (!messageElement) {
                messageElement = document.createElement('div');
                messageElement.id = 'global-message';
                messageElement.style.position = 'fixed';
                messageElement.style.top = '20px';
                messageElement.style.right = '20px';
                messageElement.style.zIndex = '1000';
                messageElement.style.padding = '15px 20px';
                messageElement.style.borderRadius = '8px';
                messageElement.style.color = 'white';
                messageElement.style.fontWeight = 'bold';
                messageElement.style.maxWidth = '400px';
                messageElement.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
                messageElement.style.transition = 'all 0.3s ease';
                document.body.appendChild(messageElement);
            }
            
            // Configurar estilo según el tipo
            if (type === 'success') {
                messageElement.style.backgroundColor = '#28a745';
            } else if (type === 'error') {
                messageElement.style.backgroundColor = '#dc3545';
            } else if (type === 'loading') {
                messageElement.style.backgroundColor = '#007bff';
            }
            
            messageElement.innerHTML = text;
            messageElement.style.display = 'block';
            messageElement.style.opacity = '1';
            
            // Ocultar después de 4 segundos (excepto para loading)
            if (type !== 'loading') {
                setTimeout(() => {
                    messageElement.style.opacity = '0';
                    setTimeout(() => {
                        messageElement.style.display = 'none';
                    }, 300);
                }, 4000);
            }
            
            return messageElement;
        }

        // Mostrar error
        function showError(message) {
            showMessage(message, 'error');
        }
    </script>


</body>
</html>