<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRUEKKI - Mi Perfil</title>
    <link rel="stylesheet" href="../css/perfil.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <header>
        <div class="container header-content">
            <div class="logo" onclick="window.location.href='barra.html'">TRUEKKI</div>
            <div class="search-bar">    
                <input type="text" placeholder="Buscar productos...">
            </div>
            <div class="user-actions">
                <a href="#" onclick="showSection('profile')">Mi cuenta</a>
                <a href="#" onclick="logout()">Salir</a>
            </div>
        </div>
    </header>
    
    <nav>
        <div class="container">
            <ul class="nav-links">
                <li><a onclick="window.location.href='index.html'">Inicio</a></li>
                <li><a onclick="window.location.href='productos.html'">Productos</a></li>
                <li><a href="#">Categorías</a></li>
                <li><a href="#">Ofertas</a></li>
                <li><a href="#">Contacto</a></li>
            </ul>
        </div>
    </nav>
    
    <div class="container main-content">
        <aside class="sidebar">
            <div class="user-profile">
                <div class="user-avatar" id="user-avatar">US</div>
                <div class="user-name" id="user-name">Cargando...</div>
                <div class="user-bio" id="user-bio">Usuario de TRUEKKI</div>
            </div>
            
            <ul class="sidebar-menu">
                <li><a onclick="showSection('profile')" class="active">Mi perfil</a></li>
                <li><a onclick="showSection('my-products')">Mis productos</a></li>
                <li><a onclick="showSection('favorites')">Favoritos</a></li>
                <li><a onclick="showSection('history')">Historial</a></li>
                <li><a onclick="showSection('messages')">Mensajes</a></li>
                <li><a href="#">Configuración</a></li>
            </ul>
        </aside>
        
        <!-- Sección de Perfil -->
        <section id="profile-section" class="content-section active">
            <h1 class="page-title">Mi Perfil</h1>
            
            <div class="profile-form">
                <div class="form-group">
                    <label for="name">Nombre completo</label>
                    <input type="text" id="name" placeholder="Cargando...">
                </div>
                
                <div class="form-group">
                    <label for="email">Correo electrónico</label>
                    <input type="email" id="email" placeholder="Cargando..." disabled>
                </div>
                
                <div class="form-group">
                    <label for="phone">Teléfono</label>
                    <input type="tel" id="phone" placeholder="Cargando...">
                </div>
                
                <div class="form-group">
                    <label for="bio">Biografía</label>
                    <textarea id="bio" placeholder="Cuéntanos algo sobre ti..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="location">Ubicación</label>
                    <input type="text" id="location" placeholder="Cargando...">
                </div>
                
                <button class="btn btn-primary" onclick="updateProfile()">Guardar cambios</button>
                <div id="profile-message" class="message-hidden"></div>
            </div>
        </section>
        
        <!-- Sección de Mis Productos -->
        <section id="my-products-section" class="content-section">
            <h1 class="page-title">Mis Productos</h1>
            
            <div class="products-grid" id="products-grid">
                <div class="loading-state">Cargando productos...</div>
            </div>
            
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-primary" onclick="window.location.href='publicar_producto.html'">Agregar nuevo producto</button>
            </div>
        </section>
        
        <!-- Sección de Favoritos -->
        <section id="favorites-section" class="content-section">
            <h1 class="page-title">Mis Favoritos</h1>
            
            <div class="favorites-grid">
                <div class="empty-state">
                    <i class="fas fa-heart"></i>
                    <h3>No tienes productos favoritos</h3>
                    <p>Cuando agregues productos a favoritos, aparecerán aquí</p>
                </div>
            </div>
        </section>
        
        <!-- Sección de Historial -->
        <section id="history-section" class="content-section">
            <h1 class="page-title">Historial de intercambios y ventas</h1>
            
            <div class="history-items">
                <div class="empty-state">
                    <i class="fas fa-history"></i>
                    <h3>No hay historial disponible</h3>
                    <p>Tu historial de intercambios y ventas aparecerá aquí</p>
                </div>
            </div>
        </section>
        
        <!-- Sección de Mensajes -->
        <section id="messages-section" class="content-section">
            <h1 class="page-title">Mensajes</h1>
            
            <div class="messages-container">
                <div class="empty-state">
                    <i class="fas fa-comments"></i>
                    <h3>No tienes mensajes</h3>
                    <p>Cuando recibas mensajes de otros usuarios, aparecerán aquí</p>
                </div>
            </div>
        </section>
    </div>
    
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>TRUEKKI</h3>
                    <p>Plataforma de intercambios y ventas de productos únicos.</p>
                </div>
                
                <div class="footer-section">
                    <h3>Enlaces rápidos</h3>
                    <ul>
                        <li><a href="#">Acerca de nosotros</a></li>
                        <li><a href="#">Términos y condiciones</a></li>
                        <li><a href="#">Política de privacidad</a></li>
                        <li><a href="#">Contacto</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h3>Categorías populares</h3>
                    <ul>
                        <li><a href="#">Tecnología</a></li>
                        <li><a href="#">Libros</a></li>
                        <li><a href="#">Ropa</a></li>
                        <li><a href="#">Hogar</a></li>
                    </ul>
                </div>
            </div>
            
            <div class="copyright">
                &copy; 2023 TRUEKKI - Todos los derechos reservados
            </div>
        </div>
    </footer>

    <!-- Script de autenticación -->
    <script src="../js/auth.js"></script>
    
    <script>
        // Variables globales
        let currentUser = null;
        let userProducts = [];

        // Cargar datos del usuario al iniciar
        document.addEventListener('DOMContentLoaded', async function() {
            // Verificar autenticación
            if (!checkAuth()) {
                return;
            }
            
            // Obtener usuario del localStorage
            currentUser = getCurrentUser();
            
            // Cargar información del usuario
            await loadUserData();
            
            // Cargar productos del usuario
            await loadUserProducts();
        });

        // Cargar datos del usuario desde la API
        async function loadUserData() {
            try {
                showLoading('profile-section');
                
                const response = await fetch(`http://localhost:5000/usuario/${currentUser.id}`);
                const result = await response.json();
                
                if (result.success) {
                    const usuario = result.usuario;
                    
                    // Actualizar UI con datos del usuario
                    document.getElementById('user-avatar').textContent = getInitials(usuario.nombre);
                    document.getElementById('user-name').textContent = usuario.nombre;
                    document.getElementById('user-bio').textContent = usuario.bio || 'Usuario de TRUEKKI';
                    
                    // Llenar formulario de perfil
                    document.getElementById('name').value = usuario.nombre;
                    document.getElementById('email').value = usuario.email;
                    document.getElementById('phone').value = usuario.numero_telefono || '';
                    document.getElementById('bio').value = usuario.bio || '';
                    document.getElementById('location').value = usuario.direccion || '';
                    
                    hideLoading('profile-section');
                } else {
                    showError('Error al cargar datos del usuario');
                    hideLoading('profile-section');
                }
            } catch (error) {
                console.error('Error cargando datos del usuario:', error);
                showError('Error de conexión al cargar datos');
                hideLoading('profile-section');
            }
        }

        // Cargar productos del usuario
        async function loadUserProducts() {
            try {
                showLoading('my-products-section');
                
                const response = await fetch(`http://localhost:5000/productos-usuario/${currentUser.id}`);
                const result = await response.json();
                
                if (result.success) {
                    userProducts = result.productos;
                    renderUserProducts();
                    hideLoading('my-products-section');
                } else {
                    showError('Error al cargar productos');
                    hideLoading('my-products-section');
                }
            } catch (error) {
                console.error('Error cargando productos del usuario:', error);
                showError('Error de conexión al cargar productos');
                hideLoading('my-products-section');
            }
        }

        // Renderizar productos del usuario
        function renderUserProducts() {
            const productsGrid = document.getElementById('products-grid');
            
            if (userProducts.length === 0) {
                productsGrid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-box-open"></i>
                        <h3>No tienes productos publicados</h3>
                        <p>Comienza a publicar productos para verlos aquí</p>
                        <button class="btn btn-primary" onclick="window.location.href='publicar_producto.html'">Publicar primer producto</button>
                    </div>
                `;
                return;
            }
            
            productsGrid.innerHTML = userProducts.map(product => `
                <div class="product-card">
                    <div class="product-image">
                        ${product.foto ? 
                            `<img src="http://localhost:5000/imagen-producto/${product.id_producto}" alt="${product.titulo}" onerror="this.style.display='none'; this.parentElement.innerHTML='${product.titulo.substring(0, 2).toUpperCase()}'">` : 
                            product.titulo.substring(0, 2).toUpperCase()
                        }
                    </div>
                    <div class="product-info">
                        <div class="product-title">${product.titulo}</div>
                        <div class="product-price">${product.precio ? `$${parseInt(product.precio).toLocaleString()}` : 'Intercambio'}</div>
                        <div class="product-stats">${product.intercambios_realizados || 0} intercambios</div>
                        <div class="product-actions">
                            <button class="btn btn-outline" onclick="editProduct(${product.id_producto})">Editar</button>
                            <button class="btn btn-primary" onclick="viewProduct(${product.id_producto})">Ver</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Obtener iniciales del nombre
        function getInitials(name) {
            return name.split(' ').map(word => word[0]).join('').toUpperCase().substring(0, 2);
        }

        // Actualizar perfil del usuario
        async function updateProfile() {
            const nombre = document.getElementById('name').value;
            const telefono = document.getElementById('phone').value;
            const bio = document.getElementById('bio').value;
            const ubicacion = document.getElementById('location').value;
            
            // Validación básica
            if (!nombre.trim()) {
                showMessage('El nombre es obligatorio', 'error');
                return;
            }
            
            try {
                showMessage('Guardando cambios...', 'loading');
                
                const response = await fetch(`http://localhost:5000/usuario/${currentUser.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        nombre: nombre,
                        numero_telefono: telefono,
                        direccion: ubicacion,
                        bio: bio
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('Perfil actualizado correctamente', 'success');
                    
                    // Actualizar UI
                    document.getElementById('user-name').textContent = nombre;
                    document.getElementById('user-bio').textContent = bio || 'Usuario de TRUEKKI';
                    document.getElementById('user-avatar').textContent = getInitials(nombre);
                    
                    // Actualizar usuario en localStorage
                    const updatedUser = {...currentUser, nombre: nombre};
                    localStorage.setItem('usuario', JSON.stringify(updatedUser));
                } else {
                    showMessage('Error: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error actualizando perfil:', error);
                showMessage('Error de conexión al actualizar perfil', 'error');
            }
        }

        // Función para cambiar entre secciones
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.getElementById(sectionId + '-section').classList.add('active');
            
            document.querySelectorAll('.sidebar-menu a').forEach(link => {
                link.classList.remove('active');
            });
            
            const activeLink = document.querySelector(`.sidebar-menu a[onclick="showSection('${sectionId}')"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
            
            // Cargar productos si se muestra la sección de mis productos
            if (sectionId === 'my-products') {
                loadUserProducts();
            }
        }

        // Ver producto
        function viewProduct(productId) {
            window.location.href = `producto.html?id=${productId}`;
        }

        // Editar producto
        function editProduct(productId) {
            window.location.href = `editar_producto.html?id=${productId}`;
        }

        // Mostrar mensaje
        function showMessage(text, type) {
            const messageElement = document.getElementById('profile-message');
            messageElement.textContent = text;
            messageElement.className = `message-${type}`;
            
            if (type !== 'loading') {
                setTimeout(() => {
                    messageElement.className = 'message-hidden';
                }, 3000);
            }
        }

        // Mostrar estado de carga
        function showLoading(section) {
            const sectionElement = document.getElementById(section);
            sectionElement.classList.add('loading');
        }

        // Ocultar estado de carga
        function hideLoading(section) {
            const sectionElement = document.getElementById(section);
            sectionElement.classList.remove('loading');
        }

        // Mostrar error
        function showError(message) {
            alert(message);
        }
    </script>
</body>
</html>